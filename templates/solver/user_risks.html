<table class="table">
    <thead>
        <tr>
            <th>Название риска</th>
            <th>Степень риска</th>
            <th>Уровень риска</th>
            <th>Меры защиты</th>
        </tr>
    </thead>
    <tbody>
        {% for risk in risks %}
        {% with risk_level=risk.get_risk_level current_score=risk.current_risk_score %}
        <tr>
            <td>
                <a href="{% url 'risk_detail' risk.id %}">{{ risk.name }}</a>
            </td>
            <td>
                {{ current_score|floatformat:2 }}
                {% if current_score != risk.risk_score %}
                <small class="text-muted d-block">
                    <s>{{ risk.risk_score|floatformat:2 }}</s>
                </small>
                {% endif %}
            </td>
            <td>
                <span class="risk-badge risk-{{ risk_level.class }}">
                    {{ risk_level.text }}
                    {% if current_score != risk.risk_score %}
                    <i class="fas fa-check-circle ml-1" title="Учтены выполненные меры"></i>
                    {% endif %}
                </span>
            </td>
            <td>
                <a href="{% url 'risk_measures' risk.id %}" class="btn btn-primary btn-sm">
                    Показать меры ({{ risk.taskrisk_set.count }})
                </a>
            </td>
        </tr>
        {% endwith %}
        {% endfor %}
    </tbody>
</table>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Обновляем данные каждые 30 секунд
    setInterval(function() {
        fetch(window.location.href)
            .then(response => response.text())
            .then(html => {
                const parser = new DOMParser();
                const newDoc = parser.parseFromString(html, 'text/html');
                const newTable = newDoc.querySelector('.table tbody');
                document.querySelector('.table tbody').innerHTML = newTable.innerHTML;
            });
    }, 30000);
});
</script>

<style>
    .risk-badge {
        padding: 0.35em 0.65em;
        border-radius: 0.25rem;
        font-weight: 700;
    }
    .risk-low {
        background-color: #d1e7dd;
        color: #0f5132;
    }
    .risk-medium {
        background-color: #fff3cd;
        color: #664d03;
    }
    .risk-high {
        background-color: #f8d7da;
        color: #842029;
    }

    .btn-sm {
        padding: 0.25rem 0.5rem;
        font-size: 0.875rem;
        line-height: 1.5;
        border-radius: 0.2rem;
    }
    .btn-primary {
        color: #fff;
        background-color: #0d6efd;
        border-color: #0d6efd;
    }

    a {
        text-decoration: none;
        color: inherit;
    }
    a:hover {
        text-decoration: underline;
    }
</style>